// What this script does:
/////////////////////////////////////
// for each file in the PATH_IDs of configuration.ts
// - load the file into memory
//     - for each point on the path
//       - move speed to top level from messagebody.coreData.speed
//       - convert speed from t/s^2 to mph then to kph
//       - add speed_unit as "kph" always
//       - drop everything under messagebody
//     - save that new array of points {filename_cleaned}.json
/////////////////////////////////////
// Explanation of this script, and a recap of how the CVE data
// was originally collected is available in the root readme.md

import * as fs from 'fs';
import { PATH_IDS, PATH_DATA_DIR } from '../configuration';

const cleanCVEData = () => {
    PATH_IDS.forEach((pathId) => {
        const newCVEData = [] as any[];
        importData(pathId, (data) => {
            data.forEach((point: any) => {
                newCVEData.push(mapPointToCleanPoint(point));
            });
            const sortedNewCVEData = sortCVEDataByTime(newCVEData);
            exportNewCVEData(sortedNewCVEData, pathId);
            console.log(`Saved ${pathId}_cleaned`);
        });
    });
};

const sortCVEDataByTime = (newCVEData: any[]) =>
    newCVEData.sort((a, b) => (a.timestamp > b.timestamp ? 1 : -1));

const exportNewCVEData = (newCVEData: any[], pathId: string) => {
    fs.writeFileSync(
        __dirname + `/../${PATH_DATA_DIR}/${pathId}_cleaned.json`,
        JSON.stringify(newCVEData, null, 2),
        { flag: 'w', encoding: 'utf-8' },
    );
};

const importData = (pathId: string, callback: (data: any) => void) => {
    import(`../${PATH_DATA_DIR}/${pathId}.json`).then(
        (data: { default: any }) => {
            callback(data.default);
        },
    );
};

const mapPointToCleanPoint = (point: any) => {
    return {
        lat: point.lat,
        long: point.long,
        speed: convertToKPH(point.messagebody.coreData.speed),
        speed_unit: 'kph',
        timestamp: point.timestamp,
    };
};

const convertToMPH = (preConvert: number) => (preConvert * 2.23694) / 50;

const convertToKPH = (preConvert: number) =>
    convertToMPH(preConvert) * 1.609344;

cleanCVEData();
