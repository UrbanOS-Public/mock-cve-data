import express from 'express';
import { HEALTH_MSG, PATH_IDS } from './configuration';
import CVEPathData from './CVEPathData';
import Vehicle from './Vehicle';
import VehicleMover from './VehicleMover';

const app = express();

const vehicles = [] as Vehicle[];
const cvePathData = new CVEPathData(PATH_IDS);

const setVehiclesOnPath = () => {
    PATH_IDS.forEach((id) => {
        vehicles.push(new Vehicle(id, cvePathData));
    });
};

const startVehicleMovement = () => {
    const mover = new VehicleMover(vehicles);
    mover.startMovingVehicles();
};

const getLocationOfAllVehicles = () =>
    vehicles.map((vehicle) => vehicle.getCurrentLocation());

cvePathData.loadCVEData().then(() => {
    setVehiclesOnPath();
    startVehicleMovement();
});

app.get('/healthcheck', function (req, res) {
    res.send(HEALTH_MSG);
});

app.get('/data', function (req, res) {
    res.send(getLocationOfAllVehicles());
});

export default app;
