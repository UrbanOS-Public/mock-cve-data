import CVEPathData, { PathPoint } from './CVEPathData';
import { v4 as uuidv4 } from 'uuid';
import { crashDuration } from './configuration';

interface VehicleLocation extends PathPoint {
    path_id: string;
    vehicle_id: string;
    speed: number;
    is_crashed: boolean;
    crash_type: CrashType | null;
}

export enum CrashType {
    ManuallyTriggered = 'MANUAL', // triggered by /crash endpoint
    AutomaticallyTriggered = 'AUTOMATIC', // triggered by internal crash timer
}

export default class Vehicle {
    private vehicleId: string;
    private vehiclePoint: number;
    private pathLength: number;
    private __isCrashed: boolean;
    private __crashType: CrashType | null;

    constructor(private pathID: string, private pathData: CVEPathData) {
        this.vehicleId = uuidv4();
        this.vehiclePoint = 0;
        this.pathLength = pathData.getPath(pathID).length;
        this.__isCrashed = false;
        this.__crashType = null;
    }

    private getPointOnPath(point: number) {
        return this.pathData.getPath(this.pathID)[point];
    }

    public advanceOnPath(): void {
        this.vehiclePoint + 1 === this.pathLength
            ? (this.vehiclePoint = 0)
            : (this.vehiclePoint += 1);
    }

    public getCurrentLocation(): VehicleLocation {
        return {
            ...this.getPointOnPath(this.vehiclePoint),
            path_id: this.pathID,
            vehicle_id: this.vehicleId,
            is_crashed: this.isCrashed(),
            crash_type: this.crashType(),
            speed: this.isCrashed() ? 0 : this.getCurrentSpeed(),
        };
    }

    public getCurrentSpeed(): number {
        return this.getPointOnPath(this.vehiclePoint).speed;
    }

    public crash(crashType: CrashType): string {
        this.__isCrashed = true;
        this.__crashType = crashType;
        setTimeout(() => this.reset(), crashDuration);
        return this.vehicleId;
    }

    public isCrashed(): boolean {
        return this.__isCrashed;
    }

    public crashType(): CrashType | null {
        return this.__crashType;
    }

    public reset(): void {
        this.__isCrashed = false;
        this.__crashType = null;
        this.vehicleId = uuidv4();
        this.vehiclePoint = 0;
    }
}
