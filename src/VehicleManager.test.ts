import VehicleManager from './VehicleManager';
import { mockVehicleFactory } from './__mocks__/Vehicle';
import { CrashType } from './Vehicle';

describe('VehicleManager', () => {
    it('Calls v.crash on only the first vehicle if none are crashed', () => {
        const v1 = mockVehicleFactory({ isCrashed: false });
        const v2 = mockVehicleFactory({ isCrashed: false });
        const vm = new VehicleManager([v1, v2]);
        vm.crashAVehicle(CrashType.ManuallyTriggered);
        expect(v1.crash).toHaveBeenCalledTimes(1);
        expect(v2.crash).toHaveBeenCalledTimes(0);
    });
    it('Calls v.crash on only the 3rd vehicle if 2 are crashed', () => {
        const v1 = mockVehicleFactory({ isCrashed: true });
        const v2 = mockVehicleFactory({ isCrashed: true });
        const v3 = mockVehicleFactory({ isCrashed: false });
        const vm = new VehicleManager([v1, v2, v3]);
        vm.crashAVehicle(CrashType.ManuallyTriggered);
        expect(v1.crash).toHaveBeenCalledTimes(0);
        expect(v2.crash).toHaveBeenCalledTimes(0);
        expect(v3.crash).toHaveBeenCalledTimes(1);
    });

    it('Provides the crashType parameter to the vehicle being crashed', () => {
        const v1 = mockVehicleFactory({ isCrashed: false });
        const vm = new VehicleManager([v1]);

        vm.crashAVehicle(CrashType.AutomaticallyTriggered);
        expect(v1.crash).toHaveBeenCalledWith(CrashType.AutomaticallyTriggered);
        vm.crashAVehicle(CrashType.ManuallyTriggered);
        expect(v1.crash).toHaveBeenCalledWith(CrashType.ManuallyTriggered);
    });

    it('Returns the ID of the vehicle crashed', () => {
        const v1 = mockVehicleFactory({
            isCrashed: false,
            vehicleId: 'fake-id',
        });
        const vm = new VehicleManager([v1]);
        expect(vm.crashAVehicle(CrashType.ManuallyTriggered)).toBe('fake-id');
    });
    it('Returns undefined if no vehicle was crashed', () => {
        const v1 = mockVehicleFactory({ isCrashed: true });
        const v2 = mockVehicleFactory({ isCrashed: true });
        const vm = new VehicleManager([v1, v2]);
        expect(vm.crashAVehicle(CrashType.ManuallyTriggered)).toBeUndefined();
    });

    it('throws an error when constructed with no vehicles', () => {
        expect(() => new VehicleManager([])).toThrowError(
            /VehicleManager constructed with no Vehicles/,
        );
    });

    it('#resetVehicles Call reset function for each vehicle', () => {
        const v1 = mockVehicleFactory({ isCrashed: true });
        const v2 = mockVehicleFactory({ isCrashed: true });
        const vm = new VehicleManager([v1, v2]);

        vm.resetVehicles();

        expect(v1.reset).toHaveBeenCalledTimes(1);
        expect(v2.reset).toHaveBeenCalledTimes(1);
    });
});
