import app from './app';
import supertest from 'supertest';
import { HEALTH_MSG, PATH_IDS } from './configuration';
import CVEPathData, { PathPoint } from './CVEPathData';
import { v4 as uuidv4 } from 'uuid';

jest.mock('uuid', () => ({ v4: () => '00000000-0000-0000-0000-000000000000' }));

let mockLoad: jest.Mock<Promise<void>, []>;
let mockGetPath: jest.Mock;
const fakePath = [{ lat: 0, long: 0, messagebody: 'fake' }];

jest.mock('./CVEPathData', function () {
    mockLoad = jest.fn(() => Promise.resolve());
    mockGetPath = jest.fn(() => fakePath);
    return jest.fn().mockImplementation(function () {
        return {
            load: mockLoad,
            getPath: mockGetPath,
        };
    });
});

describe('Application', () => {
    describe('GET - /healthcheck', () => {
        it('returns healthy', async () => {
            const res = await supertest(app).get('/healthcheck');
            expect(res.text).toEqual(HEALTH_MSG);
            expect(res.statusCode).toEqual(200);
        });
    });

    describe('GET - /data', () => {
        it('Returns the first point of each path', async () => {
            const res = await supertest(app).get('/data');
            const paths = res.body as PathPoint[];

            expect(paths?.length).toBeTruthy();
            paths.forEach((pathPoint, i) => {
                expect(pathPoint).toEqual({
                    ...fakePath[0],
                    pathId: PATH_IDS[i],
                    vehicleId: '00000000-0000-0000-0000-000000000000',
                });
            });
        });

        it('Loads CVE data', async () => {
            await supertest(app).get('/data');
            expect(mockLoad).toHaveBeenCalledTimes(1);
        });

        it('Constructs A CVEPathData instance with the configured PathIDs', async () => {
            await supertest(app).get('/data');
            expect(CVEPathData).toHaveBeenCalledWith(PATH_IDS);
        });

        it("Doesn't re-load CVE data on subsequent requests", async () => {
            await supertest(app).get('/data');
            await supertest(app).get('/data');
            expect(CVEPathData).toHaveBeenCalledTimes(1);
        });
    });
});
